<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.avg.lawsuitmanagement.lawsuit.repository.LawsuitMapperRepository">

    <select id="selectClientLawsuitList" parameterType="SelectClientLawsuitListParam" resultType="LawsuitDto">
        select l.*
        from lawsuit l
                 join lawsuit_client_map map on l.id = map.lawsuit_id
        where map.client_id = #{clientId}
          and l.is_deleted = false
        order by l.created_at desc
        limit #{limit} offset #{offset}
    </select>

    <select id="selectLawsuitById" parameterType="java.lang.Long">
        select *
        from lawsuit
        where id = #{lawsuitId} and is_deleted = false;
    </select>

    <insert id="insertLawsuit" parameterType="InsertLawsuitParam">
        insert into lawsuit (lawsuit_type, name, court_id, commission_fee, contingent_fee, lawsuit_status, lawsuit_num, result)
        values (#{lawsuitType}, #{name}, #{courtId}, #{commissionFee}, #{contingentFee}, #{lawsuitStatus}, #{lawsuitNum}, null);
    </insert>

    <!-- 추가한 데이터의 id 값을 가져옴 -->
    <select id="getLastInsertedLawsuitId" resultType="java.lang.Long">
        SELECT LAST_INSERT_ID();
    </select>

    <!-- lawsuit_client_map 테이블에 데이터 추가 -->
    <insert id="insertLawsuitClientMap" parameterType="InsertLawsuitClientMemberIdParam">
        INSERT INTO lawsuit_client_map (lawsuit_id, client_id)
        VALUES
        <foreach item="clientId" collection="clientId" separator=",">
            (#{lawsuitId}, #{clientId})
        </foreach>
    </insert>

    <!-- lawsuit_member_map 테이블에 데이터 추가 -->
    <insert id="insertLawsuitMemberMap" parameterType="InsertLawsuitClientMemberIdParam">
        INSERT INTO lawsuit_member_map (lawsuit_id, member_id)
        VALUES
        <foreach item="memberId" collection="memberId" separator=",">
            (#{lawsuitId}, #{memberId})
        </foreach>
    </insert>

    <select id="selectLawsuitList">
        select *
        from lawsuit
        where is_deleted = false;
    </select>

    <update id="updateLawsuitInfo">
        update lawsuit
        set lawsuit_type = #{lawsuit_type}, name = #{name}, court_id = #{court_id},
            commission_fee = #{commission_fee}, contingent_fee = #{contingent_fee},
            lawsuit_status = #{lawsuit_status}, lawsuit_num = #{lawsuit_num},
            result = #{result}, judgement_date = #{judgement_date}
        where id = #{lawsuitId};
    </update>

    <select id="selectClientIdByLawsuitId" parameterType="java.lang.Long">
        select client_id
        from lawsuit_client_map
        where lawsuit_id = #{lawsuitId};

    </select>

    <select id="selectMemberByLawsuitId" parameterType="java.lang.Long">
        select member_id
        from lawsuit_member_map
        where lawsuit_id = #{lawsuitId};
    </select>

    <update id="deleteLawsuitInfo" parameterType="java.lang.Long">
        update lawsuit
        set is_deleted = true
        where id = #{lawsuitId};
    </update>

    <update id="deleteLawsuitClientMap" parameterType="java.lang.Long">
        update lawsuit_client_map
        set is_deleted = true
        where lawsuit_id = #{lawsuitId};
    </update>

    <update id="deleteLawsuitMemberMap" parameterType="java.lang.Long">
        update lawsuit_member_map
        set is_deleted = true
        where lawsuit_id = #{lawsuitId};
    </update>

    <!-- cliendId가 속한 사건별 의뢰인 수 -->
    <select id="selectLawsuitCountByClientId" parameterType="java.lang.Long">
        select lcm1.lawsuit_id, count(*)
        from lawsuit_client_map lcm1
                 join lawsuit_client_map lcm2 on lcm1.lawsuit_id = lcm2.lawsuit_id
        where lcm1.is_deleted = false and lcm1.client_id = #{clientId}
        group by lcm1.lawsuit_id;
    </select>

    <!-- '사건-의뢰인' 매핑 테이블에서 해당 의뢰인 정보 삭제 -->
    <update id="deleteLawsuitClientMapByClientId" parameterType="java.lang.Long">
        update lawsuit_client_map
        set is_deleted = true
        where client_id = #{clientId};
    </update>

    <!-- 의뢰인에 대한 사건 조회 -->
    <select id="selectLawsuitByClientId" parameterType="java.lang.Long">
        select *
        from lawsuit
        where id in (
            select lawsuit_id
            from lawsuit_client_map
            where lawsuit.is_deleted = false and client_id = #{clientId}
            );
    </select>
</mapper>